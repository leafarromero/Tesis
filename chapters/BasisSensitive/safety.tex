\section{Safety properties}

\begin{lemma}[Generation lemma]
    We state some generation lemmas, which will be useful for proving subject reduction.

\begin{description}
    \item[App] If $\TYP{\Gamma}{\vec{t}\vec{s}}{B}$, then exists types $A, B'$ and contexts $\Gamma_1,\Gamma_2$ such that:
    \begin{itemize}
        \item $\TYP{\Gamma_1}{\vec{t}}{A\Arr B'}$ 
        \item $\TYP{\Gamma_2}{\vec{s}}{A}$
        \item $B'\leq B$
        \item $\flat(\Gamma\ominus\Gamma_1 , \Gamma_2)$ {\color{red}(DEFINIR CONTEXTOS FLAT)}
    \end{itemize}

    \item[UnitLam] If $\TYP{\Gamma}{\sum_{i\in I}\alpha_i (\Lam{x}{A}{\vec{t_i}})}{C}$, then exists type $B'$ and context $\Gamma'$ such that:
    \begin{itemize}
        \item $\TYP{\Gamma', x_A:B}{\sum_{i\in I}\vec{t_i}}{C'}$ 
        \item $B\Arr C'\leq C$ and {\color{red} $\flat A$, $A\leq B$ or $A =\AbsBasis$}
        \item $\flat(\Gamma\ominus\Gamma', x_A:B')$ 
    \end{itemize}

\end{description}    
\end{lemma}

\begin{proof}
    Each item is proved by derivation on the typing judgement
    \begin{description}
        \item[App:] We analyse possible rules that could yield such judgement:
        \begin{itemize}
            \item For the rules $\snam{Sub}$ or $\snam{Equiv}$, we observe that the type of the term in the hypothesis of the rule is a subtype of $B$. Then we can apply the inductive hypothesis.
            
            \item For the rules $\snam{Weak}$ or $\snam{Contr}$, we observe that the context in the hypothesis of the rule only adds or removes types that are flat ($\flat$). Then we can apply the inductive hypothesis.
            
            \item For the rule $\snam{App}$, we have that $\TYP{\Gamma_1}{\vec{t}}{A\Arr B}$ and $\TYP{\Gamma_2}{\vec{s}}{A}$. Since the relation $\leq$ is reflexive and $\Gamma_1 ,\Gamma_2 = \Gamma$, all the conditions are fulfilled.
        \end{itemize}
        
        \item[UnitLam:] We analize possible rules that could yield such judgement:
        \begin{itemize}
            \item For the rules $\snam{Sub}$ or $\snam{Equiv}$, we observe that the type of the term in the hypothesis of the rule is a subtype of $B$. Then we can apply the inductive hypothesis.
            
            \item For the rules $\snam{Weak}$ or $\snam{Contr}$, we observe that the context in the hypothesis of the rule only adds or removes types that are flat ($\flat$). Then we can apply the inductive hypothesis. 
        \end{itemize}
    \end{description}
\end{proof}


\begin{lemma}[Substitution lemma]
    Let $\TYP{\Gamma, x_A:B}{\vec{t}}{C}$ and $\TYP{}{\vec{v}}{B}$. Then, $\TYP{\Gamma\Delta}{\vec{t}\ansubst{\vec{v}/x}{A}}{C}$ 
\end{lemma}

\begin{proof}
    Proof by induction on typing judgements
\end{proof}

\begin{theorem}[Subject reduction]
    If $\TYP{\Gamma}{\vec{t}}{A}$ and $\vec{t}\eval\vec{s}$ with $A\leq B$, then $\TYP{\Gamma}{\vec{s}}{A}$.
\end{theorem}

\begin{proof}
    Proof by induction on the $\evalone$ relation.
    \begin{itemize}
        \item If we assume $\TYP{\Gamma}{\sum_{i\in I}\alpha_i(\Lam{x}{A}{\vec{t_i}})\ \vec{v}}{C}$, by {\color{red}generation lemma} we have that:
        \begin{itemize}
            \item $\TYP{\Gamma_1}{\sum_{i\in I}\alpha_i(\Lam{x}{\{\vec b_j\}_{j\in J}}{\vec{t_i}})}{B\Arr C'}$.
            \item $\TYP{\Gamma_2}{\vec{v}}{B}$.
        \end{itemize}
        Where $C\leq C'$.Then applying the generation lemma (Lam) on the first judgement we get: $\TYP{\Gamma'_1, x_A:B'}{\sum_{i\in I}\vec{t_i}}{C'}$. Then, using the substitution lemma we have that:
        \[\TYP{\Gamma'_1}{\sum_{i=1}^{n}\vec{t_i}\ansubst{\vec{v}/x}{B}}{C''}\]
        Since, $B'\Arr C''\leq B\Arr C'$, we can deduce that $C''\leq C$ and finally can apply the $\snam{Sub}$ rule and conclude:
        \[\TYP{\Gamma'_1}{\sum_{i=1}^{n}\vec{t_i}\ansubst{\vec{v}/x}{B}}{C}\]
        \end{itemize}

        \item If we assume $\LetP{x}{B}{y}{B'}{\vec v}{\vec{t}}$
\end{proof}